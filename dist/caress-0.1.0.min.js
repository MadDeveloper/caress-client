/*! caress-client - v0.1.0 - 2012-11-01
* https://github.com/ekryski/caress-client
* Copyright (c) 2012 Eric Kryski; Licensed MIT */
(function(e){typeof define=="undefined"&&(define=function(t){var n=t();typeof exports=="undefined"?window[e]=n:module.exports=n}),define(function(e,t,n){var r=r||window,i=r._;!i&&typeof e!="undefined"&&(i=e("underscore"));var s=t||{};s.version="0.1.0",s.protocol="1.1","object"==typeof n&&"function"==typeof e;var o=s.Client=function(t){t=t||{},this.host=t.host||"127.0.0.1",this.port=t.port||5e3,this.connected=!1,this.sessions={},this.cursors={},this.objects={},this.blobs={},this.touches={},this.touchList=document.createTouchList(),i.bindAll(this,"connect","onConnect","onDisconnect","processPacket","processMessage","processCursorSource","processObjectSource","processBlobSource","processCursorAlive","processObjectAlive","processBlobAlive","processCursorSet","processObjectSet","processBlobSet","processFseq")};o.prototype.connect=function(){this.socket=io.connect("http://"+this.host+":"+this.port),this.socket.on("connect",this.onConnect),this.socket.on("disconnect",this.onDisconnect)},o.prototype.onConnect=function(){this.connected=!0,this.socket.on("tuio",this.processPacket),console.log("Connected to Socket.io")},o.prototype.onDisconnect=function(){this.connected=!1;for(var e in this.touches)for(var t in this.touches[e]){var n=this.touches[e][t];delete this.touches[e][t],this.createTouchEvent("touchcancel",n)}this.touches={},this.cursors={},this.objects={},this.blobs={},console.log("Disconnected from Socket.io")},o.prototype.processPacket=function(e){e.bundle&&this.processMessage(e)},o.prototype.processMessage=function(e){var t={source:this.processCursorSource,alive:this.processCursorAlive,set:this.processCursorSet,fseq:this.processFseq},n={source:this.processObjectSource,alive:this.processObjectAlive,set:this.processObjectSet,fseq:this.processFseq},r={source:this.processBlobSource,alive:this.processBlobAlive,set:this.processBlobSet,fseq:this.processFseq};if(!e.duplicate){e.source="localhost";for(var i in e.messages){var s=e.messages[i].type;switch(e.messages[i].profile){case"/tuio/2Dcur":case"/tuio/25Dcur":case"/tuio/3Dcur":t[s](e,e.messages[i]);break;case"/tuio/2Dobj":case"/tuio/25Dobj":case"/tuio/3Dobj":n[s](e,e.messages[i]);break;case"/tuio/2Dblb":case"/tuio/25Dblb":case"/tuio/3Dblb":r[s](e,e.messages[i])}}}},o.prototype.processCursorSource=function(e,t){e.source=t.address,this.cursors[e.source]===undefined&&(this.cursors[e.source]={}),this.touches[e.source]===undefined&&(this.touches[e.source]={})},o.prototype.processObjectSource=function(e,t){e.source=t.address,this.objects[e.source]===undefined&&(this.objects[e.source]={}),this.touches[e.source]===undefined&&(this.touches[e.source]={})},o.prototype.processBlobSource=function(e,t){e.source=t.address,this.blobs[e.source]===undefined&&(this.blobs[e.source]={}),this.touches[e.source]===undefined&&(this.touches[e.source]={})},o.prototype.processCursorAlive=function(e,t){this.cursors[e.source]===undefined&&(this.cursors[e.source]={}),this.touches[e.source]===undefined&&(this.touches[e.source]={});var n=i.map(t.sessionIds,function(e){return e.toString()}),r=i.difference(i.keys(this.cursors[e.source]),n);for(var s=0;s<r.length;s++){var o=r[s],u=this.touches[e.source][o];u!==undefined&&(delete this.touches[e.source][o],delete this.cursors[e.source][o],this.createTouchEvent("touchend",u))}},o.prototype.processObjectAlive=function(e,t){this.objects[e.source]===undefined&&(this.objects[e.source]={}),this.touches[e.source]===undefined&&(this.touches[e.source]={});var n=i.map(t.sessionIds,function(e){return e.toString()}),r=i.difference(i.keys(this.objects[e.source]),n);for(var s=0;s<r.length;s++){var o=r[s],u=this.touches[e.source][o];u!==undefined&&(delete this.touches[e.source][o],delete this.objects[e.source][o],this.createTouchEvent("touchend",u))}},o.prototype.processBlobAlive=function(e,t){this.blobs[e.source]===undefined&&(this.blobs[e.source]={}),this.touches[e.source]===undefined&&(this.touches[e.source]={});var n=i.map(t.sessionIds,function(e){return e.toString()}),r=i.difference(i.keys(this.blobs[e.source]),n);for(var s=0;s<r.length;s++){var o=r[s],u=this.touches[e.source][o];u!==undefined&&(delete this.touches[e.source][o],delete this.blobs[e.source][o],this.createTouchEvent("touchend",u))}},o.prototype.processCursorSet=function(e,t){var n=new u(t),r=n.coherceToTouch(),i=t.sessionId.toString();if(this.cursors[e.source][i]!==undefined&&this.cursors[e.source][i].sessionId.toString()===i){this.cursors[e.source][i]=n;if(this.touches[e.source][i]!==undefined&&this.touches[e.source][i].identifier.toString()===i){this.touches[e.source][i]=r,this.createTouchEvent("touchmove",r);return}return}this.cursors[e.source][i]=n,this.touches[e.source][i]=r,this.createTouchEvent("touchstart",r)},o.prototype.processObjectSet=function(e,t){var n,r,i=t.sessionId.toString();if(this.objects[e.source][i]!==undefined&&this.objects[e.source][i].sessionId.toString()===i){this.objects[e.source][i]=new a(t);if(this.touches[e.source][i]!==undefined&&this.touches[e.source][i].identifier.toString()===i){r=this.objects[e.source][i].coherceToTouch(),this.touches[e.source][i]=r,this.createTouchEvent("touchmove",r);return}return}n=new a(t),r=n.coherceToTouch(),this.objects[e.source][i]=n,this.touches[e.source][i]=r,this.createTouchEvent("touchstart",r)},o.prototype.processBlobSet=function(e,t){var n,r,i=t.sessionId.toString();if(this.blobs[e.source][i]!==undefined&&this.blobs[e.source][i].sessionId.toString()===i){this.blobs[e.source][i]=new f(t);if(this.touches[e.source][i]!==undefined&&this.touches[e.source][i].identifier.toString()===i){r=this.blobs[e.source][i].coherceToTouch(),this.touches[e.source][i]=r,this.createTouchEvent("touchmove",r);return}return}n=new f(t),r=n.coherceToTouch(),this.blobs[e.source][i]=n,this.touches[e.source][i]=r,this.createTouchEvent("touchstart",r)},o.prototype.processFseq=function(e,t){},o.prototype.getCursor=function(e){return this.cursors[sessionId]},o.prototype.getObject=function(e){return this.objects[e]},o.prototype.getBlob=function(e){return this.blobs[e]},o.prototype.getCursors=function(){return this.cursors},o.prototype.getObjects=function(){return this.objects},o.prototype.getBlobs=function(){return this.blobs},o.prototype.createTouchEvent=function(e,t){var n=[];for(var r in this.touches)for(var i in this.touches[r])n.push(this.touches[r][i]);var s=t.getTargetTouches(),o=document.createTouchList([t]),u=document.createEvent("UIEvent");switch(e){case"touchstart":case"touchend":case"touchmove":u.initUIEvent(e||"",!0,!0,t.view||null,0);break;case"touchcancel":u.initUIEvent(e||"",!0,!1,t.view||null,0);break;case"touchenter":case"touchleave":u.initUIEvent(e||"",!1,!0,t.view||null,0)}u.initTouchEvent(n,s,o,e,window,t.screenX,t.screenY,t.clientX,t.clientY,u.ctrlKey,u.altKey,u.shiftKey,u.metaKey);if(t.target)t.target.dispatchEvent(u);else var a=document.dispatchEvent(u)};var u=s.TuioCursor=function(t){for(var n in t)this[n]=t[n]};u.prototype.coherceToTouch=function(){var e=this.sessionId,t=window.innerWidth*this.xPosition,n=window.innerHeight*this.yPosition,r=document.documentElement.clientWidth*this.xPosition,i=document.documentElement.clientHeight*this.yPosition,s=document.elementFromPoint(r,i),o=screen.width*this.xPosition,u=screen.height*this.yPosition,a=this.radius,f=this.radius,l=this.rotationAngle,c=this.force;return document.createTouch(s,e,t,n,r,i,o,u,a,f,l,c)};var a=s.TuioObject=function(t){for(var n in t)this[n]=t[n]};a.prototype.coherceToTouch=function(){var e=this.sessionId,t=window.innerWidth*this.xPosition,n=window.innerHeight*this.yPosition,r=document.documentElement.clientWidth*this.xPosition,i=document.documentElement.clientHeight*this.yPosition,s=document.elementFromPoint(r,i),o=screen.width*this.xPosition,u=screen.height*this.yPosition,a=this.radius,f=this.radius,l=this.rotationAngle,c=this.force;return document.createTouch(s,e,t,n,r,i,o,u,a,f,l,c)};var f=s.TuioBlob=function(t){for(var n in t)this[n]=t[n]};f.prototype.coherceToTouch=function(){var e=this.sessionId,t=window.innerWidth*this.xPosition,n=window.innerHeight*this.yPosition,r=document.documentElement.clientWidth*this.xPosition,i=document.documentElement.clientHeight*this.yPosition,s=document.elementFromPoint(r,i),o=screen.width*this.xPosition,u=screen.height*this.yPosition,a=this.radius,f=this.radius,l=this.rotationAngle,c=this.force;return document.createTouch(s,e,t,n,r,i,o,u,a,f,l,c)};var l=s.Touch=function(t,n,r,i,s,o,u,a,f,l,c,h){return this.identifier=n,this.target=t,this.screenX=u,this.screenY=a,this.clientX=r,this.clientY=i,this.pageX=s,this.pageY=o,this.radiusX=f,this.radiusY=l,this.rotationAngle=c,this.force=h,this};l.prototype.getTargetTouches=function(){var e=document.createTouchList();for(var t in window.client.touches)for(var n in window.client.touches[t]){var r=window.client.touches[t][n];r.target==this.target&&e.push(r)}return e};var c=s.TouchList=function(){var t=[].slice.call(arguments),n=t.length,r=0;this.length=n;for(;r<n;r++)this[r]=t[r];return this};c.prototype=[],c.prototype.identifiedTouch=function(e){for(var t=0;t<this.length;t++)if(this[t].identifier===e)return this[t];return undefined},c.prototype.item=function(e){return this[e]};var h=s.TouchEvent=function(){this.touches=document.createTouchList(),this.targetTouches=document.createTouchList(),this.changedTouches=document.createTouchList(),this.altKey=!1,this.metaKey=!1,this.ctrlKey=!1,this.shiftKey=!1,this.relatedTarget=null};return h.prototype=UIEvent.prototype,h.prototype.initTouchEvent=function(e,t,n,r,i,s,o,u,a,f,l,c,h){this.touches=e||document.createTouchList(),this.targetTouches=t||document.createTouchList(),this.changedTouches=n||document.createTouchList(),this.screenX=s||null,this.screenY=o||null,this.clientX=u||null,this.clientY=a||null,this.altKey=l||!1,this.metaKey=h||!1,this.ctrlKey=f||!1,this.shiftKey=c||!1,this.relatedTarget=null},h.prototype.isTouchEvent=function(){return!0},document.createTouch=function(e,t,n,r,i,s,o,u,a,f,c){return new l(e,t,n,r,i,s,o,u,a,f,c)},document.createTouchList=function(e){var t=new c;if(i.isArray(e)&&e.length){for(var n=0;n<e.length;n++)t.push(e[n]);return t}return!i.isArray(e)&&e!==undefined?(t.push(e),t):t},window.ontouchstart=document.ontouchstart=null,window.ontouchend=document.ontouchend=null,window.ontouchmove=document.ontouchmove=null,window.ontouchcancel=document.ontouchcancel=null,window.ontouchenter=document.ontouchenter=null,window.ontouchleave=document.ontouchleave=null,s})})("Caress");